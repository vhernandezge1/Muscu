{% extends "training/base.html" %}
{% block title %}Exercices - Muscu{% endblock %}

{% block content %}
<h1>Exercices de Musculation</h1>

<div class="exercises">
    {% for exercise in exercises %}
        <div>
            <strong>{{ exercise.name }}</strong><br>
            {{ exercise.muscle_group }}<br>
            {{ exercise.description }}<br>
            {{ exercise.difficulty }}
        </div>
    {% endfor %}
</div>

<hr>
<h3>üí¨ Chat en direct</h3>

<!-- Champ pseudo -->
<label for="username">Votre pseudo :</label>
<input id="username" type="text" placeholder="Entrez votre pseudo" value="Invit√©">

<!-- Zone des messages -->
<div id="chat-log" class="chat-log"></div>

<!-- Input message -->
<input id="chat-message-input" type="text" placeholder="Votre message...">
<button id="chat-message-submit">Envoyer</button>

<style>
.chat-log {
    max-height: 300px;
    overflow-y: auto;
    padding: 10px;
    background: #111827; /* fond gris fonc√© */
    border-radius: 10px;
    margin: 10px 0;
}

/* Chaque message */
.message {
    margin: 5px 0;
    padding: 8px 12px;
    border-radius: 15px;
    display: inline-block;
    max-width: 70%;
    word-wrap: break-word;
    clear: both;
    font-size: 0.9rem;
}

/* Messages de l‚Äôutilisateur courant */
.message.self {
    background: #2563eb; /* bleu */
    color: white;
    float: right;
    text-align: right;
}

/* Messages des autres */
.message.other {
    background: #374151; /* gris */
    color: white;
    float: left;
    text-align: left;
}
</style>

<script>
    // Nom du salon (modifiable pour plusieurs canaux)
    const roomName = "muscu";

    // WebSocket
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/' + roomName + '/'
    );

    // Pseudo utilisateur
    const usernameInput = document.querySelector('#username');
    let username = usernameInput.value;

    usernameInput.addEventListener("change", () => {
        username = usernameInput.value || "Invit√©";
    });

    // R√©ception d‚Äôun message
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const chatLog = document.querySelector('#chat-log');
        const msg = document.createElement('div');

        msg.className = (data.username === username) ? "message self" : "message other";
        msg.innerText = `${data.username}: ${data.message}`;
        
        chatLog.appendChild(msg);
        chatLog.scrollTop = chatLog.scrollHeight; // auto-scroll
    };

    chatSocket.onopen = () => console.log("‚úÖ WebSocket connect√©");
    chatSocket.onclose = () => console.error("‚ùå WebSocket ferm√©");

    // Envoi d‚Äôun message
    document.querySelector('#chat-message-submit').onclick = function(e) {
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;

        if (message.trim() !== "") {
            console.log("üì§ Envoi du message:", message);
            chatSocket.send(JSON.stringify({
                'username': username,
                'message': message
            }));
            messageInputDom.value = '';
        }
    };
</script>

{% endblock %}
