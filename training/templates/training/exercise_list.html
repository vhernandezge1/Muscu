{% extends "training/base.html" %}
{% block title %}Exercices - Muscu{% endblock %}

{% block content %}
<h1>Exercices de Musculation</h1>

<div class="exercises">
    {% for exercise in exercises %}
        <div>
            <strong>{{ exercise.name }}</strong><br>
            {{ exercise.muscle_group }}<br>
            {{ exercise.description }}<br>
            {{ exercise.difficulty }}
        </div>
    {% endfor %}
</div>

<hr>
<h3>üí¨ Chat en direct</h3>

<!-- Choix du salon et pseudo -->
<label for="room">Salon :</label>
<select id="room">
    <option value="muscu">Muscu</option>
    <option value="nutrition">Nutrition</option>
    <option value="general">G√©n√©ral</option>
</select>

<label for="username">Votre pseudo :</label>
<input id="username" type="text" placeholder="Entrez votre pseudo" value="Invit√©">

<!-- Zone des messages -->
<div id="chat-log" class="chat-log"></div>

<!-- Input message -->
<input id="chat-message-input" type="text" placeholder="Votre message...">
<button id="chat-message-submit">Envoyer</button>

<style>
.chat-log {
    max-height: 300px;
    overflow-y: auto;
    padding: 10px;
    background: #111827; /* gris fonc√© */
    border-radius: 10px;
    margin: 10px 0;
}

.message {
    margin: 5px 0;
    padding: 8px 12px;
    border-radius: 15px;
    display: inline-block;
    max-width: 70%;
    word-wrap: break-word;
    clear: both;
}

.message.self {
    background: #2563eb; /* bleu */
    color: white;
    float: right;
    text-align: right;
}

.message.other {
    background: #374151; /* gris */
    color: white;
    float: left;
}

/* Style meta infos */
.meta {
    display: block;
    font-size: 0.8em;
    margin-bottom: 3px;
}

/* Couleurs pseudo */
.username-color-0 { color: #60a5fa; } /* bleu */
.username-color-1 { color: #34d399; } /* vert */
.username-color-2 { color: #f472b6; } /* rose */
.username-color-3 { color: #facc15; } /* jaune */
.username-color-4 { color: #a78bfa; } /* violet */

.time {
    color: #9ca3af; /* gris clair */
    margin-left: 5px;
    font-size: 0.75em;
}
</style>

<script>
let chatSocket = null;
let username = document.querySelector('#username').value;
let roomName = document.querySelector('#room').value;

// G√©n√®re une couleur pseudo constante
function getColorClass(username) {
    const colors = 5;
    let hash = 0;
    for (let i = 0; i < username.length; i++) {
        hash = username.charCodeAt(i) + ((hash << 5) - hash);
    }
    const index = Math.abs(hash) % colors;
    return "username-color-" + index;
}

// Connexion WS
function connectWebSocket() {
    if (chatSocket) {
        chatSocket.close();
    }

    chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/' + roomName + '/'
    );

    chatSocket.onopen = () => console.log("‚úÖ WebSocket connect√© au salon:", roomName);
    chatSocket.onclose = () => console.log("‚ùå WebSocket ferm√©");

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const chatLog = document.querySelector('#chat-log');
        const msg = document.createElement('div');

        if (data.username === username) {
            msg.className = "message self";
        } else {
            msg.className = "message other";
        }

        // heure locale
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        msg.innerHTML = `
            <span class="meta">
                <span class="${getColorClass(data.username)}">${data.username}</span>
                <span class="time">${time}</span>
            </span>
            ${data.message}
        `;

        chatLog.appendChild(msg);
        chatLog.scrollTop = chatLog.scrollHeight;
    };
}

// Update pseudo et salon
document.querySelector('#username').addEventListener("change", e => {
    username = e.target.value;
});
document.querySelector('#room').addEventListener("change", e => {
    roomName = e.target.value;
    connectWebSocket();
});

// Envoi message
document.querySelector('#chat-message-submit').onclick = function() {
    const messageInputDom = document.querySelector('#chat-message-input');
    const message = messageInputDom.value;
    if (message.trim() !== "") {
        chatSocket.send(JSON.stringify({
            'username': username,
            'message': message
        }));
        messageInputDom.value = '';
    }
};

// Connexion initiale
connectWebSocket();
</script>

{% endblock %}
